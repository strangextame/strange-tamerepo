{% extends "base.html" %}

{% block title %}Search for a Card{% endblock %}

{% block content %}
<div class="p-4 p-md-5 mb-4 rounded-3 bg-body-tertiary">
  <div class="container-fluid">
    <h1 class="display-5 fw-bold">Magic Card Search</h1>
    <p class="col-md-8 fs-4">Enter a card name to search the Scryfall database.</p>
    
    <form action="{{ url_for('search') }}" method="POST" class="row g-3 align-items-end">
      <div class="col-md-6">
        <label for="card_name" class="form-label">Card Name</label>
        <input type="text" name="card_name" id="card_name" class="form-control form-control-lg" placeholder="e.g., Sol Ring" required autofocus list="card-suggestions">
        <datalist id="card-suggestions"></datalist>
      </div>
      <div class="col-md-4">
        <label for="card_type" class="form-label">Card Type</label>
        <select name="card_type" id="card_type" class="form-select form-select-lg">
          <option value="" selected>Any Type</option>
          <option value="creature">Creature</option>
          <option value="instant">Instant</option>
          <option value="sorcery">Sorcery</option>
          <option value="artifact">Artifact</option>
          <option value="enchantment">Enchantment</option>
          <option value="land">Land</option>
          <option value="planeswalker">Planeswalker</option>
        </select>
      </div>
      <div class="col-md-2">
        <button class="btn btn-primary btn-lg w-100" type="submit">Search</button>
        </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const cardNameInput = document.getElementById('card_name');
    const suggestionsDatalist = document.getElementById('card-suggestions');
    let debounceTimer;
    
    // --- Initial Check ---
    if (!cardNameInput) {
        console.error('CRITICAL ERROR: Could not find card name input with ID "card_name". Check your HTML.');
        return; // Stop script execution if essential element is missing
    }
    if (!suggestionsDatalist) {
        console.error('CRITICAL ERROR: Could not find datalist with ID "card-suggestions". Check your HTML.');
        // Continue, as the input might still work, but autocomplete won't display.
    }
    console.log('DOMContentLoaded: Script loaded and elements checked. (Mic Check #0)'); // Mic Check #0

    cardNameInput.addEventListener('input', () => {
      console.log('Event: Input detected (Mic Check #1).'); // Mic Check #1
      // Clear the previous timer to debounce the input
      clearTimeout(debounceTimer);

      debounceTimer = setTimeout(() => {
        const query = cardNameInput.value;

        if (query.length < 2) {
          console.log('Event: Query too short (< 2 chars). Clearing suggestions.');
          suggestionsDatalist.innerHTML = ''; 
          return;
        }
        console.log('Event: Query is long enough. Attempting to fetch suggestions for:', query, '(Mic Check #2).'); // Mic Check #2

        // Fetch suggestions from our new /autocomplete endpoint
        fetch(`{{ url_for('autocomplete') }}?q=${encodeURIComponent(query)}`)
          .then(response => {
            console.log('Fetch Step 1: Received network response (status:', response.status, response.statusText, '). (Mic Check #3)'); // Mic Check #3
            // Check if the HTTP response is successful
            if (!response.ok) {
              console.error('Network response was not ok:', response.status, response.statusText);
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            console.log('Received suggestions:', data);
            if (Array.isArray(data) && data.length > 0) {
                console.log('Populating datalist with', data.length, 'suggestions.');
                suggestionsDatalist.innerHTML = data.map(item => `<option value="${item}"></option>`).join('');
            } else {
                console.log('Received empty or non-array data. Clearing datalist.');
                suggestionsDatalist.innerHTML = '';
            }
          })
          .catch(error => {
            console.error('CRITICAL ERROR: Error fetching autocomplete suggestions:', error); // CRITICAL ERROR
          });
      }, 250); // Wait 250ms after user stops typing
    });
  });
</script>
{% endblock %}