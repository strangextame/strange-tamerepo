{% extends "base.html" %}

{% block title %}Search for a Card{% endblock %}

{% block content %}
<div class="p-4 p-md-5 mb-4 rounded-3 bg-body-tertiary">
  <div class="container-fluid">
    <h1 class="display-5 fw-bold">Magic Card Search</h1>
    <p class="col-md-8 fs-4">Enter a card name to search the Scryfall database.</p>
    
    <form action="{{ url_for('search') }}" method="POST" class="row g-3 align-items-end">
      <div class="col-md-6">
        <label for="card_name" class="form-label">Card Name</label>
        <input type="text" name="card_name" id="card_name" class="form-control form-control-lg" placeholder="e.g., Sol Ring" required autofocus list="card-suggestions">
        <datalist id="card-suggestions"></datalist>
      </div>
      <div class="col-md-4">
        <label for="card_type" class="form-label">Card Type</label>
        <select name="card_type" id="card_type" class="form-select form-select-lg">
          <option value="" selected>Any Type</option>
          <option value="creature">Creature</option>
          <option value="instant">Instant</option>
          <option value="sorcery">Sorcery</option>
          <option value="artifact">Artifact</option>
          <option value="enchantment">Enchantment</option>
          <option value="land">Land</option>
          <option value="planeswalker">Planeswalker</option>
        </select>
      </div>
      <div class="col-md-2">
        <button class="btn btn-primary btn-lg w-100" type="submit">Search</button>
        </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const cardNameInput = document.getElementById('card_name');
    const suggestionsDatalist = document.getElementById('card-suggestions');
    let debounceTimer;

    cardNameInput.addEventListener('input', () => {
      // Clear the previous timer to debounce the input
      clearTimeout(debounceTimer);

      debounceTimer = setTimeout(() => {
        const query = cardNameInput.value;

        if (query.length < 2) {
          suggestionsDatalist.innerHTML = ''; // Clear suggestions for short queries
          return;
        }

        // Fetch suggestions from our new /autocomplete endpoint
        fetch(`{{ url_for('autocomplete') }}?q=${encodeURIComponent(query)}`)
          .then(response => {
            // Check if the HTTP response is successful
            if (!response.ok) {
              console.error('Network response was not ok:', response.status, response.statusText);
              // Stop processing and trigger the .catch()
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            // This is the suggestion from your counterpart: log the received data.
            console.log('Received suggestions:', data);
            suggestionsDatalist.innerHTML = data.map(item => `<option value="${item}"></option>`).join('');
          })
          .catch(error => {
            // This will catch network errors or errors from the .then() blocks.
            console.error('Error fetching autocomplete suggestions:', error);
          });
      }, 250); // Wait 250ms after user stops typing
    });
  });
</script>
{% endblock %}